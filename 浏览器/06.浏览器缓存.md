# 浏览器缓存

浏览器对于缓存的处理是根据第一次请求资源时返回的响应头来确认的

根据响应头，浏览器缓存策略一般分为：强缓存、协商缓存

浏览器常见字段和指令

+ `Expires`: 告知客户端资源缓存失效的绝对时间
+ `Last-Modified`: 资源最后一次修改的时间
+ `Etag`: 文件的特殊标识
+ `Cache-Control`:告诉客户端或是服务器如何处理缓存

  + `Cache-Control: private`：表示客户端可以缓存
  + `Cache-Control: public` ：表示客户端和代理服务器都可缓存，如果没有明确指定 private，则默认为 public
  + `Cache-Control: no-cache`: 表示需要可以缓存，但每次用应该去向服务器验证缓存是否可用
  + `Cache-Control: no-store`: 表示所有内容都不会缓存，强制缓存，对比缓存都不会触发.
  + `Cache-Control: max-age=xxx`: 表示缓存的内容将在 xxx 秒后失效

自从 HTTP 1.1开始，Expires 逐渐被 Cache-Control 取代。Cache-Control 是一个相对时间，即使客户端时间发生改变，相对时间也不会随之改变，这样可以保持服务器和客户端的时间一致性

![浏览器缓存](../img/浏览器缓存.png)

## 缓存

强缓存简单理解就是给浏览器缓存设置过期时间，超过这个时间之后缓存就是过期，浏览器需要重新请求

强缓存主要是通过 HTTP 请求头中的 Expires 和 Cache-Control 两个字段控制

Expires 是一个HTTP/1.0的字段，它给浏览器设置了一个绝对时间，当浏览器时间超过这个绝对时间之后，重新向服务器发送请求

+ 它描述的是一个绝对时间，用 GMT 格式的字符串表示

  `Expires: Wed Feb 20 2019 11:25:41 GMT`

+ 也可以在 HTML 文件里直接使用

  `<meta http-equiv="expires" content="Wed Feb 20 2019 11:25:41 GMT">`

+ 弊端：Expires 返回的是服务器的时间，但判断的时候用的却是客户端的时间，因为用户有可能改变客户端的时间，导致缓存时间判断出错，这也是引入Cache-Control:max-age 指令的原因之一

为了解决 Expires 存在的问题，HTTP/1.1 版本中提出了 Cache-Control:max-age

该字段与 Expires 的缓存思路相同，都是设置了一个过期时间，不同的是 max-age 设置的是相对缓存时间开始往后的多少秒，因此不再受日期不准确情况的影响

在优先级上 max-age > Expires，当两者同时出现在响应头时, Expires 将被 max-age覆盖

  `Cache-control: max-age=666` 表示资源会在 666 秒后过期，需要再次请求

## 协商缓存

协商缓存的过程是，先从缓存中获取对应的数据标识，然后向服务器发送请求，确认数据是否更新，如果更新，则返回新数据和新缓存；反之，则返回304状态码，告知客户端缓存未更新，可继续使用

协商缓存主要应用于一些时常需要动态更新的资源文件，解决了无法及时获取更新资源的问题

协商缓存在协议里的字段是 Last-Modified 和 If-Modified-Since

+ `Last-Modified`：服务器告知客户端，资源最后一次被修改的时间

    `Last-Modified: Wed Feb 20 2019 14:08:32 GMT`

+ `If-Modified-Since`：再次请求时，请求头中带有该字段，服务器会将 `If-Modified-Since` 的值与 `Last-Modified` 字段进行对比，如果相等，则表示未修改，响应304 Not Modified；反之，则表示修改了，响应200状态码，返回数据

缺点：

+ `Last-Modified`，`If-Modified-Since` 都是以秒为单位进行更新，如果小于该单位高频进行更新的话，则不适合采用该方法

+ 如果文件是通过服务器动态生成的，那么该方法的更新时间永远是生成的时间，尽管文件可能没有变化，所以起不到缓存的作用

另外一对 header 来管理协商缓存，ETag、If-None-Match

`Etag` 存储的是文件的特殊标识(一般都是 hash 生成的)，服务器存储着文件的 `Etag` 字段，可以在与每次客户端传送`If-no-match` 的字段进行比较，如果相等，则表示未修改，响应304；反之，则表示已修改，响应200状态码，返回数据

优先级：

`ETag` 与 `If-None-Match` > `Last-Modified` 与 `If-Modified-Since`, 同时存在时, 前者覆盖后者
